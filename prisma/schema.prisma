generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String           @id @default(cuid())
  user_code          String           @unique
  username           String           @unique
  email              String           @unique
  password_hash      String
  full_name          String
  profile_image_url  String?
  role               UserRole         @default(USER)
  sponsor_id         String?
  created_at         DateTime         @default(now())
  updated_at         DateTime         @updatedAt
  password_resets    PasswordReset[]
  purchases          Purchase[]
  sponsor            User?            @relation("SponsorTree", fields: [sponsor_id], references: [id])
  referrals          User[]           @relation("SponsorTree")
  wallet_ledger      WalletLedger[]
  withdrawals        Withdrawal[]
  task_completions   TaskCompletion[]

  @@index([sponsor_id])
  @@index([user_code])
  @@index([username])
  @@index([email])
}

model VipPackage {
  id                Int        @id @default(autoincrement())
  level             Int        @unique
  name              String
  investment_bs     Float
  daily_profit_bs   Float
  is_enabled        Boolean    @default(true)
  qr_image_url      String?
  package_image_url String?
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  purchases         Purchase[]

  @@index([level])
}

model Purchase {
  id              String         @id @default(cuid())
  user_id         String
  vip_package_id  Int
  investment_bs   Float
  daily_profit_bs Float
  receipt_url     String
  status          PurchaseStatus @default(PENDING)
  activated_at    DateTime?
  last_profit_at  DateTime?
  total_earned_bs Float          @default(0)
  roulette_spun   Boolean        @default(false)
  roulette_won_bs Float          @default(0)
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  user            User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  vip_package     VipPackage     @relation(fields: [vip_package_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([activated_at])
  @@index([last_profit_at])
}

model WalletLedger {
  id          String     @id @default(cuid())
  user_id     String
  type        LedgerType
  amount_bs   Float
  description String?
  created_at  DateTime   @default(now())
  user        User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([type])
  @@index([created_at])
}

model Withdrawal {
  id             String           @id @default(cuid())
  user_id        String
  amount_bs      Float
  qr_image_url   String?
  bank_name      String           @default("")
  account_number String           @default("")
  payout_method  String           @default("")
  phone_number   String           @default("")
  status         WithdrawalStatus @default(PENDING)
  receipt_url    String?
  processed_at   DateTime?
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  user           User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
}

model ReferralBonusRule {
  id         Int      @id @default(autoincrement())
  level      Int      @unique
  percentage Float
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([level])
}

model Banner {
  id         Int            @id @default(autoincrement())
  location   BannerLocation
  image_url  String
  link_url   String?
  order      Int            @default(0)
  is_active  Boolean        @default(true)
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt

  @@index([location, order])
}

model Announcement {
  id         Int      @id @default(autoincrement())
  title      String
  body       String
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([is_active])
  @@index([created_at])
}

model EffortBonus {
  id                      Int      @id @default(autoincrement())
  title                   String
  target_kpi              String
  level_description       String
  amount_bs               Float
  requirement_description String
  sort_order              Int      @default(0)
  is_active               Boolean  @default(true)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  @@index([sort_order])
}

model PasswordReset {
  id         String   @id @default(cuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

model DailyProfitRun {
  id          Int      @id @default(1)
  last_run_at DateTime
}

model DailyTask {
  id          Int              @id @default(autoincrement())
  position    Int              @unique // 1, 2, 3, or 4
  image_url   String
  is_active   Boolean          @default(true)
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
  completions TaskCompletion[]

  @@index([position])
}

model TaskCompletion {
  id            String    @id @default(cuid())
  user_id       String
  task_id       Int
  rating        Int       // 1-5 stars
  comment       String
  completed_at  DateTime  @default(now())
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  task          DailyTask @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@unique([user_id, task_id, completed_at])
  @@index([user_id])
  @@index([task_id])
  @@index([completed_at])
}

model GlobalConfig {
  id              Int      @id @default(1)
  whatsapp_number String   @default("")
  updated_at      DateTime @updatedAt
}

enum UserRole {
  USER
  ADMIN
}

enum PurchaseStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum WithdrawalStatus {
  PENDING
  PAID
  REJECTED
}

enum LedgerType {
  DAILY_PROFIT
  REFERRAL_BONUS
  WITHDRAW_REQUEST
  WITHDRAW_REJECT
  ADJUSTMENT
  ROULETTE_WIN
}

enum BannerLocation {
  HOME_TOP
  HOME_BOTTOM
}
